---
title: NHP outputs report
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: true
params:
  r: NA
  sites: NA
---

```{r}
#| label: setup
#| echo: FALSE

knitr::opts_chunk$set(error = TRUE, echo = FALSE)

r <- params$r
p <- get_params(r)
```

This is model run `r params$r$params$id`.

## Input parameters

### Model run

```{r}
#| label: params-model-run

p_model_run <- purrr::keep(p, rlang::is_atomic)

p_model_run[["start_year"]] <- scales::number(
  p_model_run[["start_year"]] + ((p_model_run[["start_year"]] + 1) %% 100) / 100,
  0.01,
  big.mark = "", decimal.mark = "/"
)
p_model_run[["end_year"]] <- scales::number(
  p_model_run[["end_year"]] + ((p_model_run[["end_year"]] + 1) %% 100) / 100,
  0.01,
  big.mark = "",
  decimal.mark = "/"
)

p_model_run[["create_datetime"]] <- p_model_run[["create_datetime"]] |>
  lubridate::fast_strptime("%Y%m%d_%H%M%S") |>
  format("%d-%b-%Y %H:%M:%S")

p_model_run |>
  unlist() |>
  tibble::enframe() |> 
  gt::gt("name") |> 
  gt_theme()
```

### Demographic adjusment

```{r}
#| label: params-demographic-adjustment

info_params_table_demographic_adjustment(p)
```

### Baseline adjustment

```{r}
#| label: params-baseline-adjustment

info_params_table_baseline_adjustment(p)
```

### Covid adjustment

```{r}
#| label: params-covid-adjustment

info_params_table_covid_adjustment(p)
```

### Waiting list adjustment

```{r}
#| label: params-waiting-list-adjustment

info_params_table_waiting_list_adjustment(p)
```

### Expat

```{r}
#| label: params-expat

info_params_table_expat_repat_adjustment(p, "expat")
```

### Repat (local)

```{r}
#| label: params-repat-local

info_params_table_expat_repat_adjustment(p, "repat_local")
```

### Repat (non-local)

```{r}
#| label: params-repat-non-local

info_params_table_expat_repat_adjustment(p, "repat_nonlocal")
```

### Non-demographic adjustment

```{r}
#| label: params-non-demographic-adjustment

info_params_table_non_demographic_adjustment(p)
```

### Activity avoidance

```{r}
#| label: params-activity-avoidance

info_params_table_activity_avoidance(p)
```

### Efficiencies

```{r}
#| label: params-efficiencies

info_params_table_efficiencies(p)
```

### Bed occupancy

```{r}
#| label: params-bed-occupancy-day-night

info_params_table_bed_occupancy_day_night(p)
```

```{r}
#| label: params-bed-occupancy-specialty-mapping

info_params_table_bed_occupancy_specialty_mapping(p)
```

## Outputs

### Principal projection

#### Summary

```{r}
#| label: pp-summary

mod_principal_summary_data(r, params$sites) |> 
  mod_principal_summary_table()
```

#### Impact of changes


```{r}
#| label: pp-impact-of-changes-setup

prep_principal_change_factors <- function(data, at, mitigator_lookup) {
  
  data |> 
    get_principal_change_factors(at) |>
    dplyr::mutate(
      dplyr::across("change_factor", forcats::fct_inorder),
      dplyr::across(
        "change_factor",
        \(.x) forcats::fct_relevel(
          .x, 
          "baseline", 
          "demographic_adjustment", 
          "health_status_adjustment"
        )
      )
    ) |>
    dplyr::left_join(
      mitigator_lookup,
      by = dplyr::join_by("strategy")
    ) |>
    tidyr::replace_na(list("mitigator_name" = "-"))
  
}

mitigator_lookup <- app_sys("app", "data", "mitigators.json") |>
  jsonlite::read_json(simplifyVector = TRUE) |>
  purrr::simplify() |>
  tibble::enframe("strategy", "mitigator_name")

ip_pcf  <- prep_principal_change_factors(r, "ip",  mitigator_lookup) 
op_pcf  <- prep_principal_change_factors(r, "op",  mitigator_lookup) 
aae_pcf <- prep_principal_change_factors(r, "aae", mitigator_lookup) 
```

##### Inpatients

###### Bed days

```{r}
#| label: pp-impact-of-changes-ip-bed-days

ip_pcf |> 
  mod_principal_change_factor_effects_summarised("beddays", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

###### Admissions

```{r}
#| label: pp-impact-of-changes-ip-admissions

ip_pcf |> 
  mod_principal_change_factor_effects_summarised("admissions", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

##### Outpatients

###### Attendances

```{r}
#| label: pp-impact-of-changes-op-attendances

op_pcf |> 
  mod_principal_change_factor_effects_summarised("attendances", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

###### Tele-attendances

```{r}
#| label: pp-impact-of-changes-op-tele-attendances

op_pcf |> 
  mod_principal_change_factor_effects_summarised("tele_attendances", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

##### A&E

###### Arrivals

```{r}
#| label: pp-impact-of-changes-aae-arrivals

aae_pcf |> 
  mod_principal_change_factor_effects_summarised("arrivals", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

#### Summary by year

##### Values

```{r}
#| label: pp-summary-by-year

principal_high_level_summary_data <- 
  mod_principal_high_level_pods() |> 
  mod_principal_high_level_summary_data(r, pods = _, params$sites)

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "value")
```

##### Change

```{r}
#| label: pp-summary-by-year-change

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "change")
```

##### Percent change

```{r}
#| label: pp-summary-by-year-percent-change

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "change_pcnt")
```


##### Inpatient admissions

```{r}
#| label: pp-summary-by-year-plot-ip

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "ip")
```

##### Outpatient attendances

```{r}
#| label: pp-summary-by-year-plot-op

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "op")
```

##### A&E attendances

Available at trust level only.

```{r}
#| label: pp-summary-by-year-plot-aae

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "aae")
```


#### Activity in detail

```{r}
#| label: pp-activity-in-detail

```

### Distribution of projections

#### Activity summary

```{r}
#| label: dop-activity-summary

```

#### Activity distribution

```{r}
#| label: dop-activity-distribution

```
