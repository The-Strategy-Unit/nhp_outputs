---
title: NHP Outputs Report 
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float:
      collapsed: true
params:
  r: NA
  sites: NA
---

```{r}
#| label: setup
#| echo: false

knitr::opts_chunk$set(error = TRUE, echo = FALSE)
source(here::here("R", "fct_report.R"), local = knitr::knit_global())
```

```{css}
h1 {
font-size: 32px;
}

h2 {
font-size: 28px;
}

h3 {
font-size: 26px;
}

h4 {
font-size: 24px;
}

h5 {
font-size: 22px;
}

h6 {
font-size: 20px;
}

p {
font-size: 16px;
}
```

```{r}
#| label: site-selections

sites_were_selected <- if (is.null(params$sites)) FALSE else TRUE

selected_sites <- if (sites_were_selected) {
  paste(params$sites, collapse = ", ")
} else {
  "all"
}
```

---
subtitle: Model run `r params$r$params$id` with `r selected_sites` sites selected
---

## Notes

See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information) for an overview, user guide and methodology for the model and the outputs app.

This report reflects the site selections made in the app before the 'download report' button was clicked. The site selections for this report are: `r selected_sites`.

Note that A&E results are not shown if you selected sites. Some sections will not contain charts and data if they weren't supplied or if there's insufficient data. 

## Input parameters

```{r}
#| label: setup-params

p <- get_params(params$r)
```

### Model run

```{r}
#| label: params-model-run

p_model_run <- purrr::keep(p, rlang::is_atomic)

p_model_run[["start_year"]] <- scales::number(
  p_model_run[["start_year"]] + ((p_model_run[["start_year"]] + 1) %% 100) / 100,
  0.01,
  big.mark = "", decimal.mark = "/"
)
p_model_run[["end_year"]] <- scales::number(
  p_model_run[["end_year"]] + ((p_model_run[["end_year"]] + 1) %% 100) / 100,
  0.01,
  big.mark = "",
  decimal.mark = "/"
)

p_model_run[["create_datetime"]] <- p_model_run[["create_datetime"]] |>
  lubridate::fast_strptime("%Y%m%d_%H%M%S") |>
  format("%d-%b-%Y %H:%M:%S")

p_model_run |>
  unlist() |>
  tibble::enframe() |> 
  gt::gt("name") |> 
  gt_theme() |> 
  gt::tab_options(table.align = "left")
```

### Demographic adjustment

```{r}
#| label: params-demographic-adjustment

info_params_table_demographic_adjustment(p) |> 
  gt::tab_options(table.align = "left")
```

### Baseline adjustment

```{r}
#| label: params-baseline-adjustment

info_params_table_baseline_adjustment(p) |> 
  gt::tab_options(table.align = "left")
```

### Covid adjustment

```{r}
#| label: params-covid-adjustment

info_params_table_covid_adjustment(p) |> 
  gt::tab_options(table.align = "left")
```

### Waiting list adjustment

```{r}
#| label: params-waiting-list-adjustment

info_params_table_waiting_list_adjustment(p) |> 
  gt::tab_options(table.align = "left")
```

### Expat

```{r}
#| label: params-expat

info_params_table_expat_repat_adjustment(p, "expat") |> 
  gt::tab_options(table.align = "left")
```

### Repat (local)

```{r}
#| label: params-repat-local

info_params_table_expat_repat_adjustment(p, "repat_local") |> 
  gt::tab_options(table.align = "left")
```

### Repat (non-local)

```{r}
#| label: params-repat-non-local

info_params_table_expat_repat_adjustment(p, "repat_nonlocal") |> 
  gt::tab_options(table.align = "left")
```

### Non-demographic adjustment

```{r}
#| label: params-non-demographic-adjustment

info_params_table_non_demographic_adjustment(p) |> 
  gt::tab_options(table.align = "left")
```

### Activity avoidance

```{r}
#| label: params-activity-avoidance

info_params_table_activity_avoidance(p) |> 
  gt::tab_options(table.align = "left")
```

### Efficiencies

```{r}
#| label: params-efficiencies

info_params_table_efficiencies(p) |> 
  gt::tab_options(table.align = "left")
```

### Bed occupancy

```{r}
#| label: params-bed-occupancy-day-night

info_params_table_bed_occupancy_day_night(p) |> 
  gt::tab_options(table.align = "left")
```

```{r}
#| label: params-bed-occupancy-specialty-mapping

info_params_table_bed_occupancy_specialty_mapping(p) |> 
  gt::tab_options(table.align = "left")
```

## Outputs

### Principal projection

#### Summary

A&E and bed-availability data are not available at site level. See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information/user_guide/glossary.html) for definitions of terms.

```{r}
#| label: pp-summary

mod_principal_summary_data(params$r, params$sites) |> 
  mod_principal_summary_table() |> 
  gt::tab_options(table.align = "left")
```

#### Impact of changes

The results should be regarded as rough, high-level estimates of the number of rows added/removed due to each parameter. See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information/user_guide/glossary.html) for definitions of terms.

```{r}
#| label: pp-impact-of-changes-setup

mitigator_lookup <- app_sys("app", "data", "mitigators.json") |>
  jsonlite::read_json(simplifyVector = TRUE) |>
  purrr::simplify() |>
  tibble::enframe("strategy", "mitigator_name")

ip_pcf  <- prep_principal_change_factors(at = "ip") 
op_pcf  <- prep_principal_change_factors(at = "op") 
aae_pcf <- prep_principal_change_factors(at = "aae")
```

##### Inpatients

###### Bed days

```{r}
#| label: pp-impact-of-changes-ip-bed-days

plot_impact_and_individual_change(ip_pcf, "beddays") |> purrr::walk(print)
```

###### Admissions

```{r}
#| label: pp-impact-of-changes-ip-admissions

plot_impact_and_individual_change(ip_pcf, "admissions") |> purrr::walk(print)
```

##### Outpatients

###### Attendances

```{r}
#| label: pp-impact-of-changes-op-attendances

plot_impact_and_individual_change(op_pcf, "attendances") |> purrr::walk(print)
```

###### Tele-attendances

```{r}
#| label: pp-impact-of-changes-op-tele-attendances

plot_impact_and_individual_change(op_pcf, "tele_attendances") |>
  purrr::walk(print)
```

##### A&E

###### Arrivals

```{r}
#| label: pp-impact-of-changes-aae-arrivals

plot_impact_and_individual_change(aae_pcf, "arrivals") |> purrr::walk(print)
```

#### Summary by year

A&E results are not available at site level. See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information/user_guide/glossary.html) for definitions of terms.

##### Values

```{r}
#| label: pp-summary-by-year

principal_high_level_summary_data <- 
  mod_principal_high_level_pods() |> 
  mod_principal_high_level_summary_data(params$r, pods = _, params$sites)

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "value")
```

##### Change

```{r}
#| label: pp-summary-by-year-change

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "change")
```

##### Percent change

```{r}
#| label: pp-summary-by-year-percent-change

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "change_pcnt")
```


##### Inpatient admissions

```{r}
#| label: pp-summary-by-year-plot-ip

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "ip")
```

##### Outpatient attendances

```{r}
#| label: pp-summary-by-year-plot-op

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "op")
```

##### A&E attendances (trust-level)

Available at trust level only.

```{r}
#| label: pp-summary-by-year-plot-aae

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "aae")
```

#### Activity in detail

A&E results are not available at site level. See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information/user_guide/glossary.html) for definitions of terms.

```{r}
#| label: pp-activity-in-detail-setup

tretspef_lookup <- jsonlite::read_json(
  app_sys("app", "data", "tx-lookup.json"),
  simplifyVector = TRUE
) |>
  dplyr::mutate(
    dplyr::across("Description", \(x) stringr::str_remove(x, " Service$")),
    dplyr::across("Description", \(x) paste0(.data$Code, ": ", .data$Description)),
  ) |>
  dplyr::select(-"Group")

# Function to prepare data and table

possibly_generate_activity_in_detail_table <- purrr::possibly(
  generate_activity_in_detail_table,
  otherwise = "Insufficient information to produce this table"
)

# Prepare sets of inputs (activity, pods, measure, aggregation, sites)

atpmo_agg <- get_activity_type_pod_measure_options() |> 
  dplyr::select("activity_type", "pod", "measure" = "measures") |> 
  tidyr::crossing(agg_col = c("age_group", "tretspef")) |> 
  dplyr::mutate(
    activity_type = dplyr::case_match(
      activity_type, 
      "ip" ~ "inpatients",
      "op" ~ "outpatients",
      "aae" ~ "aae"
    )
  )

activity_in_detail_table_names <- atpmo_agg |> 
  dplyr::mutate(table_name = paste(pod, measure, agg_col, sep = "_")) |>
  dplyr::pull()

# Prepare a list with each set of input combos

activity_in_detail_tables <- purrr::pmap(
  atpmo_agg, 
  possibly_generate_activity_in_detail_table
) |> 
  purrr::set_names(activity_in_detail_table_names)
```

##### Inpatients

###### Elective admissions

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-1

activity_in_detail_tables$ip_elective_admission_admissions_age_group
```

Admissions by age group by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-2

activity_in_detail_tables$ip_elective_admission_admissions_tretspef
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-3

activity_in_detail_tables$ip_elective_admission_beddays_age_group
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-4

activity_in_detail_tables$ip_elective_admission_beddays_tretspef
```

###### Elective daycases

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-5

activity_in_detail_tables$ip_elective_daycase_admissions_age_group
```

Admissions by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-6

activity_in_detail_tables$ip_elective_daycase_admissions_tretspef
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-7

activity_in_detail_tables$ip_elective_daycase_beddays_age_group
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-8

activity_in_detail_tables$ip_elective_daycase_beddays_tretspef
```

###### Maternity

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-9

activity_in_detail_tables$ip_maternity_admission_admissions_age_group
```

Admissions by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-10

activity_in_detail_tables$ip_maternity_admission_admissions_tretspef
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-11

activity_in_detail_tables$ip_maternity_admission_beddays_age_group
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-12

activity_in_detail_tables$ip_maternity_admission_beddays_tretspef
```

###### Non-elective

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-13

activity_in_detail_tables$`ip_non-elective_admission_admissions_age_group`
```

Admissions by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-14

activity_in_detail_tables$`ip_non-elective_admission_admissions_tretspef`
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-15 

activity_in_detail_tables$`ip_non-elective_admission_beddays_age_group`
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-16 

activity_in_detail_tables$`ip_non-elective_admission_beddays_tretspef`
```

##### Outpatients

###### First

Attendances by age group

```{r}
#| label: pp-activity-in-detail-op-1

activity_in_detail_tables$op_first_attendances_age_group
```

Attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-2

activity_in_detail_tables$op_first_attendances_tretspef
```

Tele-attendances by age group

```{r}
#| label: pp-activity-in-detail-op-3

activity_in_detail_tables$op_first_tele_attendances_age_group
```

Tele-attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-4

activity_in_detail_tables$op_first_tele_attendances_tretspef
```

###### Follow-up

Attendances by age group

```{r}
#| label: pp-activity-in-detail-op-5

activity_in_detail_tables$`op_follow-up_attendances_age_group`
```

Attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-6

activity_in_detail_tables$`op_follow-up_attendances_tretspef`
```

Tele-attendances by age group

```{r}
#| label: pp-activity-in-detail-op-7

activity_in_detail_tables$`op_follow-up_tele_attendances_age_group`
```

Tele-attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-8

activity_in_detail_tables$`op_follow-up_tele_attendances_tretspef`
```

###### Procedure

Attendances by age group

```{r}
#| label: pp-activity-in-detail-op-9

activity_in_detail_tables$op_procedure_attendances_age_group
```

Attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-10

activity_in_detail_tables$op_procedure_attendances_tretspef
```

##### A&E

###### Type 1 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-1

activity_in_detail_tables$`aae_type-01_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-2

activity_in_detail_tables$`aae_type-01_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-3

activity_in_detail_tables$`aae_type-01_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-4

activity_in_detail_tables$`aae_type-01_walk-in_tretspef`
```

###### Type 2 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-5

activity_in_detail_tables$`aae_type-02_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-6

activity_in_detail_tables$`aae_type-02_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-7

activity_in_detail_tables$`aae_type-02_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-8

activity_in_detail_tables$`aae_type-02_walk-in_tretspef`
```

###### Type 3 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-9

activity_in_detail_tables$`aae_type-03_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-10

activity_in_detail_tables$`aae_type-03_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-11

activity_in_detail_tables$`aae_type-03_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-12

activity_in_detail_tables$`aae_type-03_walk-in_tretspef`
```

###### Type 4 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-13

activity_in_detail_tables$`aae_type-04_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-14

activity_in_detail_tables$`aae_type-04_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-15

activity_in_detail_tables$`aae_type-04_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-16

activity_in_detail_tables$`aae_type-04_walk-in_tretspef`
```

### Distribution of projections

#### Activity summary

A&E results are not available at site level. See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information/user_guide/glossary.html) for definitions of terms.

```{r}
#| label: dop-activity-summary

atpmo <- get_activity_type_pod_measure_options()

params$r |>
  get_model_core_activity(params$sites) |>
  dplyr::inner_join(atpmo, by = c("pod", "measure" = "measures")) |> 
  mod_model_core_activity_server_table() |> 
  gt::tab_options(table.width = gt::pct(100))
```

#### Activity distribution

A&E results are not available at site level. See [the model project information site](https://connect.strategyunitwm.nhs.uk/nhp/project_information/user_guide/glossary.html) for definitions of terms.

```{r}
#| label: dop-activity-distribution-setup

# Prepare sets of inputs (activity, pods, measure, aggregation, sites)

atpmo_simplified <- get_activity_type_pod_measure_options() |> 
  dplyr::select("activity_type", "pod", "measure" = "measures") |> 
  dplyr::mutate(
    activity_type = dplyr::case_match(
      activity_type, "ip" ~ "inpatients", "op" ~ "outpatients", "aae" ~ "aae"
    )
  )

activity_distribution_table_names <- atpmo_simplified |> 
  dplyr::mutate(table_name = paste(pod, measure, sep = "_")) |>
  dplyr::pull()

# Prepare a list of plots with each set of input combos

possibly_plot_activity_distributions <- purrr::possibly(
  plot_activity_distributions,
  otherwise = "Insufficient information to produce this chart"
)

activity_distributions <- atpmo_simplified |>
  purrr::pmap(possibly_plot_activity_distributions) |>
  purrr::set_names(activity_distribution_table_names)
```

##### Inpatients

###### Non-elective admission

Admissions

```{r}
#| label: pp-activity-distribution-ip-1

activity_distributions$`ip_non-elective_admission_admissions` |>
  purrr::walk(print)
```

Bed days

```{r}
#| label: pp-activity-distribution-ip-2

activity_distributions$`ip_non-elective_admission_beddays` |> purrr::walk(print)
```

###### Elective admission

```{r}
#| label: pp-activity-distribution-ip-3

activity_distributions$`ip_elective_admission_admissions` |> purrr::walk(print)
```

Bed days

```{r}
#| label: pp-activity-distribution-ip-4

activity_distributions$`ip_elective_admission_beddays` |> purrr::walk(print)
```

###### Maternity admission

```{r}
#| label: pp-activity-distribution-ip-5

activity_distributions$`ip_maternity_admission_admissions` |> purrr::walk(print)
```

Bed days

```{r}
#| label: pp-activity-distribution-ip-6

activity_distributions$`ip_maternity_admission_beddays` |> purrr::walk(print)
```

##### Outpatients

###### First

Attendances

```{r}
#| label: pp-activity-distribution-op-1

activity_distributions$`op_first_attendances` |> purrr::walk(print)
```

Tele-attendances

```{r}
#| label: pp-activity-distribution-op-2

activity_distributions$`op_first_tele_attendances` |> purrr::walk(print)
```

###### Follow-up

Attendances

```{r}
#| label: pp-activity-distribution-op-3

activity_distributions$`op_follow-up_attendances` |> purrr::walk(print)
```

Tele-attendances

```{r}
#| label: pp-activity-distribution-op-4

activity_distributions$`op_follow-up_tele_attendances` |> purrr::walk(print)
```

##### A&E

###### Type 1

Ambulance

```{r}
#| label: pp-activity-distribution-aae-1

activity_distributions$`aae_type-01_ambulance` |> purrr::walk(print)
```

Walk-in

```{r}
#| label: pp-activity-distribution-aae-2

activity_distributions$`aae_type-01_walk-in` |> purrr::walk(print)
```

###### Type 2

Ambulance

```{r}
#| label: pp-activity-distribution-aae-3

activity_distributions$`aae_type-02_ambulance` |> purrr::walk(print)
```

Walk-in

```{r}
#| label: pp-activity-distribution-aae-4

activity_distributions$`aae_type-02_walk-in` |> purrr::walk(print)
```

###### Type 3

Ambulance

```{r}
#| label: pp-activity-distribution-aae-5

activity_distributions$`aae_type-03_ambulance` |> purrr::walk(print)
```

Walk-in

```{r}
#| label: pp-activity-distribution-aae-6

activity_distributions$`aae_type-03_walk-in` |> purrr::walk(print)
```

###### Type 4

Ambulance

```{r}
#| label: pp-activity-distribution-aae-7

activity_distributions$`aae_type-04_ambulance` |> purrr::walk(print)
```

Walk-in

```{r}
#| label: pp-activity-distribution-aae-8

activity_distributions$`aae_type-04_walk-in` |> purrr::walk(print)
```
