---
title: NHP outputs report
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float:
      collapsed: true
params:
  r: NA
  sites: NA
---

```{r}
#| label: setup
#| echo: FALSE

knitr::opts_chunk$set(error = TRUE, echo = FALSE)

r <- params$r
p <- get_params(r)
```

## Input parameters

### Model run

```{r}
#| label: params-model-run

p_model_run <- purrr::keep(p, rlang::is_atomic)

p_model_run[["start_year"]] <- scales::number(
  p_model_run[["start_year"]] + ((p_model_run[["start_year"]] + 1) %% 100) / 100,
  0.01,
  big.mark = "", decimal.mark = "/"
)
p_model_run[["end_year"]] <- scales::number(
  p_model_run[["end_year"]] + ((p_model_run[["end_year"]] + 1) %% 100) / 100,
  0.01,
  big.mark = "",
  decimal.mark = "/"
)

p_model_run[["create_datetime"]] <- p_model_run[["create_datetime"]] |>
  lubridate::fast_strptime("%Y%m%d_%H%M%S") |>
  format("%d-%b-%Y %H:%M:%S")

p_model_run |>
  unlist() |>
  tibble::enframe() |> 
  gt::gt("name") |> 
  gt_theme()
```

### Demographic adjusment

```{r}
#| label: params-demographic-adjustment

info_params_table_demographic_adjustment(p)
```

### Baseline adjustment

```{r}
#| label: params-baseline-adjustment

info_params_table_baseline_adjustment(p)
```

### Covid adjustment

```{r}
#| label: params-covid-adjustment

info_params_table_covid_adjustment(p)
```

### Waiting list adjustment

```{r}
#| label: params-waiting-list-adjustment

info_params_table_waiting_list_adjustment(p)
```

### Expat

```{r}
#| label: params-expat

info_params_table_expat_repat_adjustment(p, "expat")
```

### Repat (local)

```{r}
#| label: params-repat-local

info_params_table_expat_repat_adjustment(p, "repat_local")
```

### Repat (non-local)

```{r}
#| label: params-repat-non-local

info_params_table_expat_repat_adjustment(p, "repat_nonlocal")
```

### Non-demographic adjustment

```{r}
#| label: params-non-demographic-adjustment

info_params_table_non_demographic_adjustment(p)
```

### Activity avoidance

```{r}
#| label: params-activity-avoidance

info_params_table_activity_avoidance(p)
```

### Efficiencies

```{r}
#| label: params-efficiencies

info_params_table_efficiencies(p)
```

### Bed occupancy

```{r}
#| label: params-bed-occupancy-day-night

info_params_table_bed_occupancy_day_night(p)
```

```{r}
#| label: params-bed-occupancy-specialty-mapping

info_params_table_bed_occupancy_specialty_mapping(p)
```

## Outputs

### Principal projection

#### Summary

```{r}
#| label: pp-summary

mod_principal_summary_data(r, params$sites) |> 
  mod_principal_summary_table()
```

#### Impact of changes

```{r}
#| label: pp-impact-of-changes-setup

prep_principal_change_factors <- function(data, at, mitigator_lookup) {
  
  data |> 
    get_principal_change_factors(at) |>
    dplyr::mutate(
      dplyr::across("change_factor", forcats::fct_inorder),
      dplyr::across(
        "change_factor",
        \(.x) forcats::fct_relevel(
          .x, 
          "baseline", 
          "demographic_adjustment", 
          "health_status_adjustment"
        )
      )
    ) |>
    dplyr::left_join(
      mitigator_lookup,
      by = dplyr::join_by("strategy")
    ) |>
    tidyr::replace_na(list("mitigator_name" = "-"))
  
}

mitigator_lookup <- app_sys("app", "data", "mitigators.json") |>
  jsonlite::read_json(simplifyVector = TRUE) |>
  purrr::simplify() |>
  tibble::enframe("strategy", "mitigator_name")

ip_pcf  <- prep_principal_change_factors(r, "ip",  mitigator_lookup) 
op_pcf  <- prep_principal_change_factors(r, "op",  mitigator_lookup) 
aae_pcf <- prep_principal_change_factors(r, "aae", mitigator_lookup) 
```

##### Inpatients

###### Bed days

```{r}
#| label: pp-impact-of-changes-ip-bed-days

ip_pcf |> 
  mod_principal_change_factor_effects_summarised("beddays", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

###### Admissions

```{r}
#| label: pp-impact-of-changes-ip-admissions

ip_pcf |> 
  mod_principal_change_factor_effects_summarised("admissions", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

##### Outpatients

###### Attendances

```{r}
#| label: pp-impact-of-changes-op-attendances

op_pcf |> 
  mod_principal_change_factor_effects_summarised("attendances", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

###### Tele-attendances

```{r}
#| label: pp-impact-of-changes-op-tele-attendances

op_pcf |> 
  mod_principal_change_factor_effects_summarised("tele_attendances", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

##### A&E

###### Arrivals

```{r}
#| label: pp-impact-of-changes-aae-arrivals

aae_pcf |> 
  mod_principal_change_factor_effects_summarised("arrivals", TRUE) |>
  mod_principal_change_factor_effects_cf_plot()
```

#### Summary by year

##### Values

```{r}
#| label: pp-summary-by-year

principal_high_level_summary_data <- 
  mod_principal_high_level_pods() |> 
  mod_principal_high_level_summary_data(r, pods = _, params$sites)

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "value")
```

##### Change

```{r}
#| label: pp-summary-by-year-change

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "change")
```

##### Percent change

```{r}
#| label: pp-summary-by-year-percent-change

principal_high_level_summary_data |> 
  mod_principal_high_level_table(summary_type = "change_pcnt")
```


##### Inpatient admissions

```{r}
#| label: pp-summary-by-year-plot-ip

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "ip")
```

##### Outpatient attendances

```{r}
#| label: pp-summary-by-year-plot-op

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "op")
```

##### A&E attendances

Available at trust level only.

```{r}
#| label: pp-summary-by-year-plot-aae

principal_high_level_summary_data |> 
  mod_principal_high_level_plot(activity_type = "aae")
```

#### Activity in detail

```{r}
#| label: pp-activity-in-detail-setup

tretspef_lookup <- jsonlite::read_json(
  app_sys("app", "data", "tx-lookup.json"),
  simplifyVector = TRUE
) |>
  dplyr::mutate(
    dplyr::across("Description", \(x) stringr::str_remove(x, " Service$")),
    dplyr::across("Description", \(x) paste0(.data$Code, ": ", .data$Description)),
  ) |>
  dplyr::select(-"Group")

# Function to prepare data and table

generate_activity_in_detail_table <- function(
    activity_type, pod, measure, agg_col
) {
  
  aggregated_data <- r |>
    get_aggregation(pod, measure, agg_col, NULL) |>
    shiny::req() |>
    dplyr::transmute(
      .data$sex,
      agg = .data[[agg_col]],
      .data$baseline,
      final = .data$principal,
      change = .data$final - .data$baseline,
      change_pcnt = .data$change / .data$baseline
    )
  
  if (agg_col == "tretspef") {
    aggregated_data <- aggregated_data |>
      dplyr::left_join(
        tretspef_lookup,
        by = dplyr::join_by("agg" == "Code")
      ) |>
      dplyr::mutate(
        dplyr::across(
          "Description",
          \(x) dplyr::if_else(is.na(x), .data$agg, .data$Description)
        ),
      ) |>
      dplyr::select("sex", "Description", dplyr::everything(), -"agg") |>
      dplyr::rename("agg" = "Description")
  }
  
  end_year <- r[["params"]][["end_year"]]
  end_fyear <- paste0(
    end_year, "/",
    as.numeric(stringr::str_extract(end_year, "\\d{2}$")) + 1
  )
  
  aggregated_data |> 
    mod_principal_detailed_table(
      aggregation = agg_col,
      final_year = end_fyear
    ) |> 
    gt::tab_options(table.width = gt::pct(100))
  
}

possibly_generate_activity_in_detail_table <- 
  purrr::possibly(generate_activity_in_detail_table)

# Prepare sets of inputs (activity, pods, measure, aggregation, sites)

atpmo_agg <- get_activity_type_pod_measure_options() |> 
  dplyr::select("activity_type", "pod", "measure" = "measures") |> 
  tidyr::crossing(agg_col = c("age_group", "tretspef")) |> 
  dplyr::mutate(
    activity_type = dplyr::case_match(
      activity_type, 
      "ip" ~ "inpatients",
      "op" ~ "outpatients",
      "aae" ~ "aae"
    )
  )

activity_in_detail_table_names <- atpmo_agg |> 
  dplyr::mutate(
    table_name = paste(pod, measure, agg_col, sep = "_")
  ) |>
  dplyr::pull()

# Prepare a list with each set of input combos

activity_in_detail_tables <- purrr::pmap(
  atpmo_agg, 
  possibly_generate_activity_in_detail_table
) |> 
  purrr::set_names(activity_in_detail_table_names)
```

##### Inpatients

###### Elective admissions

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-1

activity_in_detail_tables$ip_elective_admission_admissions_age_group
```

Admissions by age group by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-2

activity_in_detail_tables$ip_elective_admission_admissions_tretspef
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-3

activity_in_detail_tables$ip_elective_admission_beddays_age_group
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-4

activity_in_detail_tables$ip_elective_admission_beddays_tretspef
```

###### Elective daycases

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-5

activity_in_detail_tables$ip_elective_daycase_admissions_age_group
```

Admissions by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-6

activity_in_detail_tables$ip_elective_daycase_admissions_tretspef
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-7

activity_in_detail_tables$ip_elective_daycase_beddays_age_group
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-8

activity_in_detail_tables$ip_elective_daycase_beddays_tretspef
```

###### Maternity

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-9

activity_in_detail_tables$ip_maternity_admission_admissions_age_group
```

Admissions by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-10

activity_in_detail_tables$ip_maternity_admission_admissions_tretspef
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-11

activity_in_detail_tables$ip_maternity_admission_beddays_age_group
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-12

activity_in_detail_tables$ip_maternity_admission_beddays_tretspef
```

###### Non-elective

Admissions by age group

```{r}
#| label: pp-activity-in-detail-ip-13

activity_in_detail_tables$`ip_non-elective_admission_admissions_age_group`
```

Admissions by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-14

activity_in_detail_tables$`ip_non-elective_admission_admissions_tretspef`
```

Bed days by age group

```{r}
#| label: pp-activity-in-detail-ip-15 

activity_in_detail_tables$`ip_non-elective_admission_beddays_age_group`
```

Bed days by treatment specialty

```{r}
#| label: pp-activity-in-detail-ip-16 

activity_in_detail_tables$`ip_non-elective_admission_beddays_tretspef`
```

##### Outpatients

###### First

Attendances by age group

```{r}
#| label: pp-activity-in-detail-op-1

activity_in_detail_tables$op_first_attendances_age_group
```

Attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-2

activity_in_detail_tables$op_first_attendances_tretspef
```

Tele-attendances by age group

```{r}
#| label: pp-activity-in-detail-op-3

activity_in_detail_tables$op_first_tele_attendances_age_group
```

Tele-attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-4

activity_in_detail_tables$op_first_tele_attendances_tretspef
```

###### Follow-up

Attendances by age group

```{r}
#| label: pp-activity-in-detail-op-5

activity_in_detail_tables$`op_follow-up_attendances_age_group`
```

Attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-6

activity_in_detail_tables$`op_follow-up_attendances_tretspef`
```

Tele-attendances by age group

```{r}
#| label: pp-activity-in-detail-op-7

activity_in_detail_tables$`op_follow-up_tele_attendances_age_group`
```

Tele-attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-8

activity_in_detail_tables$`op_follow-up_tele_attendances_tretspef`
```

###### Procedure

Attendances by age group

```{r}
#| label: pp-activity-in-detail-op-9

activity_in_detail_tables$op_procedure_attendances_age_group
```

Attendances by treatment specialty

```{r}
#| label: pp-activity-in-detail-op-10

activity_in_detail_tables$op_procedure_attendances_tretspef
```

##### A&E

###### Type 1 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-1

activity_in_detail_tables$`aae_type-01_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-2

activity_in_detail_tables$`aae_type-01_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-3

activity_in_detail_tables$`aae_type-01_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-4

activity_in_detail_tables$`aae_type-01_walk-in_tretspef`
```

###### Type 2 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-5

activity_in_detail_tables$`aae_type-02_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-6

activity_in_detail_tables$`aae_type-02_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-7

activity_in_detail_tables$`aae_type-02_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-8

activity_in_detail_tables$`aae_type-02_walk-in_tretspef`
```

###### Type 3 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-9

activity_in_detail_tables$`aae_type-03_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-10

activity_in_detail_tables$`aae_type-03_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-11

activity_in_detail_tables$`aae_type-03_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-12

activity_in_detail_tables$`aae_type-03_walk-in_tretspef`
```

###### Type 4 department

Ambulance by age group

```{r}
#| label: pp-activity-in-detail-aae-13

activity_in_detail_tables$`aae_type-04_ambulance_age_group`
```

Ambulance by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-14

activity_in_detail_tables$`aae_type-04_ambulance_tretspef`
```

Walk-in by age group

```{r}
#| label: pp-activity-in-detail-aae-15

activity_in_detail_tables$`aae_type-04_walk-in_age_group`
```

Walk-in by treatment specialty

```{r}
#| label: pp-activity-in-detail-aae-16

activity_in_detail_tables$`aae_type-04_walk-in_tretspef`
```

### Distribution of projections

#### Activity summary

```{r}
#| label: dop-activity-summary

atpmo <- get_activity_type_pod_measure_options()

r |>
  get_model_core_activity(params$sites) |>
  dplyr::inner_join(atpmo, by = c("pod", "measure" = "measures")) |> 
  mod_model_core_activity_server_table() |> 
  gt::tab_options(table.width = gt::pct(100))
```

#### Activity distribution

```{r}
#| label: dop-activity-distribution-setup

# Prepare sets of inputs (activity, pods, measure, aggregation, sites)

atpmo_simplified <- get_activity_type_pod_measure_options() |> 
  dplyr::select("activity_type", "pod", "measure" = "measures") |> 
  dplyr::mutate(
    activity_type = dplyr::case_match(
      activity_type, "ip" ~ "inpatients", "op" ~ "outpatients", "aae" ~ "aae"
    )
  )

activity_distribution_table_names <- atpmo_simplified |> 
  dplyr::mutate(table_name = paste(pod, measure, sep = "_")) |>
  dplyr::pull()

# Functions to prepare data and plot 

generate_activity_distribution_beeswarm <- function(
    activity_type, pod, measure
) {
  
  selected_measure <- c(activity_type, pod, measure)
  
  aggregated_data <- r |>
    mod_model_results_distribution_get_data(selected_measure, params$sites) |>
    require_rows()
  
  mod_model_results_distribution_beeswarm_plot(
    aggregated_data,
    show_origin = FALSE
  )
  
}

generate_activity_distribution_ecdf <- function(activity_type, pod, measure) {
  
  selected_measure <- c(activity_type, pod, measure)
  
  aggregated_data <- r |>
    mod_model_results_distribution_get_data(selected_measure, params$sites) |>
    require_rows()
  
  mod_model_results_distribution_ecdf_plot(
    aggregated_data,
    show_origin = FALSE
  )
  
}

possibly_generate_activity_distribution_beeswarm <- 
  purrr::possibly(generate_activity_distribution_beeswarm)

possibly_generate_activity_distribution_ecdf <- 
  purrr::possibly(generate_activity_distribution_ecdf)

# Prepare a list with each set of input combos

activity_distribution_beeswarms <- atpmo_simplified |> 
  purrr::pmap(possibly_generate_activity_distribution_beeswarm) |> 
  purrr::set_names(activity_distribution_table_names)

activity_distribution_ecdfs <- atpmo_simplified |> 
  purrr::pmap(possibly_generate_activity_distribution_ecdf) |> 
  purrr::set_names(activity_distribution_table_names)
```

##### Inpatients

Test: non-elective admissions

```{r}
activity_distribution_beeswarms$`ip_non-elective_admission_admissions`
```

```{r}
activity_distribution_ecdfs$`ip_non-elective_admission_admissions`
```

##### Outpatients

##### A&E
